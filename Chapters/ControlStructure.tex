This section is concerned with the control structure of the WDN.

\subsection{System Linearisation}\label{subsec:Linearisation}

Before the model presented in \cref{eq:NonLinearModelWithTank} is truly useful to us - at least within the scope of the \textit{linear} control strategies considered in this project - we must find a way to turn it into a linear model. The typical approach to this problem is \textit{linearisation}, whereby we exploit the extremely powerful Hartman-Grobman theorem, which we present roughly as outlined in \cite{Perko2001}:


\begin{theorem}\label{theorem:HartmanGrobman}
(\textbf{The Hartman-Grobman Theorem}) Let $E$ be an open subset of $\mathbb{R}^n$ containing the origin, and let $f$ be a continuously differentiable function on $E$:
 
\begin{equation*}
f \in C^1(E))
\end{equation*}

Let $\gamma_t$ be the flow of the nonlinear system $\dot{x} = f(x)$. Assume furthermore that there exists an equilibrium point at the origin: 

\begin{equation*}
f(0) = 0
\end{equation*}

and that this equilibrium point is hyberbolic: 

\begin{equation*}
\forall \lambda \in T(A): \ \text{Re}(\lambda) > 0, \quad A = \nabla f  
\end{equation*}

where $T$ is the eigenspace of $A$. Then there exists a homeomorphism $H$ of some open set $U, \ 0 \in U$ onto the open set $V, \ 0 \in V$, such that $\forall x_0 \in U$, there is an open interval $I_0 \subset \mathbb{R}, \ 0 \in I_0$ such that:

\begin{equation*}
	\forall x_0 \in U \wedge \forall t \in I_0: \ H \circ \gamma_t(x_0) = e^{At}H(x_0)
\end{equation*}
\end{theorem}

At first glance, this theorem looks opaquely mathematical and not immediately applicable. However, in practice, \cref{theorem:HartmanGrobman} simply tells us that in the immediate vicinity of some hyperbolic equilibrium point of our nonlinear system, there exists a \textit{linear} system that behaves in a generally identical manner when evolved in time. We note that it is not \textit{necessary} to linearise at a hyperbolic equilibrium, but doing so is favourable when possible as it precludes the presence of a center manifold, whose dynamics may not be captured by linearisation.

Recalling that the first-order Taylor series of a function at a point can be thought of as a  generalisation of its tangent line, it is then possible to identify the linearisation of our system via:

\begin{equation}\label{eq:TaylorSeries}
\dot{x} \approx f(x_0) + \nabla f\bigg\rvert_{x_0} (x-x_0)
\end{equation}

We now revert our attention to the nonlinear model of the WDN. We will make the simplifying assumption that $\Phi \mathcal{J} \Phi^T$ is invertible, which is not generally true, but tends to hold for the type of WDN in question. We also introduce the notation $\mathcal{P}: (\Phi \mathcal{J} \Phi^T)^{-1}$, allowing allows us to rewrite \cref{eq:NonLinearModelWithTank} as:

\begin{equation}\label{eq:NonLinearModelSimplified}
	\begin{split}
		\dot{q}_n &=  -\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\
		&= 	-\mathcal{P}\Phi\Big(\lambda(q_n)+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+\alpha(q_n,\omega)\Big) + 	\mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\
		& = -\mathcal{P}\Phi\Big(K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q+a_2|q|q\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big)
	\end{split}	
\end{equation}

We now make the additional observation that the terms $\Psi(\bar{h}-\mathbf{1}h_0)$ and  $\mathcal{I}(p_{\tau}-\mathbf{1}p_0)$ do not depend on $\{q_n,OD,\omega\}$. This suggests that, when computing the Taylor expansion, these terms disappear under the action of the $\nabla$ operator, i.e. that:

\begin{equation}\label{eq:PressureHeightDisappear}
	\begin{split}
		\nabla \dot{q}_n &= \nabla \Big(-\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\ 
		&=\nabla \Big(-\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big)\Big) \\
		&=\nabla \Big(-\mathcal{P}\Phi\Big(K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q+a_2|q|q\Big)\Big)
	\end{split}
\end{equation}

Recognizing furthermore that $\Phi$ and $\mathcal{J}$ are simply linear transformations, the linearity of differentiation then allows us to write a general expression for the Taylor expansion of \cref{eq:NonLinearModelSimplified} as:

\begin{equation}\label{eq:SymbolicLinearisation}
	\begin{split}
		\dot{q}_n &\approx f(x_0) + \frac{\partial f}{\partial q_n}\bigg\rvert_{x_0} \tilde{q}_n + \frac{\partial f}{\partial OD}\bigg\rvert_{x_0} \tilde{OD} + \frac{\partial f}{\partial \omega}\bigg\rvert_{x_0} \tilde{\omega} 
		\\
		&= f(x_0) - \mathcal{P}\Phi\Big( \frac{\partial \Omega}{\partial q_n}\bigg\rvert_{x_0} \tilde{q}_n + \frac{\partial \Omega}{\partial OD}\bigg\rvert_{x_0} \tilde{OD} + \frac{\partial \Omega}{\partial \omega}\bigg\rvert_{x_0} \tilde{\omega} \Big)
	\end{split}
\end{equation}

where: 

\begin{align}
	x_0 &= \{q_0,OD_0,\omega_0\} \label{eq:EquilibriumPoint} \\
	\Omega &= K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q_n+a_2|q_n|q_n \label{eq:OmegaFun} \\
	\tilde{q}_n &= q_n - q_0 \label{eq:QTilde} \\
	\tilde{OD} &= OD - OD_0 \label{eq:ODTilde} \\ 
	\tilde{\omega} &= \omega - \omega_0 \label{eq:OmegaTilde} 
\end{align}

Writing out each of the partial derivatives in \cref{eq:SymbolicLinearisation}, we get:

\begin{equation}\label{eq:PartialTaylorQ}
	\frac{\partial \Omega}{\partial q_n}\bigg\rvert_{x_0} 
	=
	a_1\omega_0 + \Big(|q_0|+ \text{sign}(q_0)q_0\Big)\Bigg(K_\lambda + a_2 + \frac{1}{(K_v OD_0)^2}\Bigg) 
\end{equation}

\begin{equation}\label{eq:PartialTaylorOD}
	\frac{\partial \Omega}{\partial OD}\bigg\rvert_{x_0} 
	=
	-|q_0|q_0 \frac{2}{K_v^2 OD_0^3}
\end{equation}

\begin{equation}\label{eq:PartialTaylorOmega}
	\frac{\partial \Omega}{\partial \omega}\bigg\rvert_{x_0} 
	=
	a_1 q_0 + 2a_0\omega_0
\end{equation}

and the complete Taylor expansion becomes:

\begin{equation}\label{eq:SymbolicLinearisationExpanded}
	\begin{split}
			\dot{q}_n \approx f(x_0) &-\mathcal{P}\Phi\Bigg(a_1\omega_0 + \Big(|q_0|+\text{sign}(q_0)q_0\Big)\Bigg(K_\lambda + a_2 + \frac{1}{(K_v OD_0)^2}\Bigg) \tilde{q}_n \Bigg)  \\
			&- \mathcal{P}\Phi\Bigg(\Big(-|q_0|q_0 \frac{2}{K_v^2 OD_0^3}\Big) \tilde{OD}\Bigg) \\
			&-  \mathcal{P}\Phi\Bigg(\Big(a_1 q_0 + 2a_0\omega_0\Big) \tilde{\omega}\Bigg)
	\end{split}
\end{equation}




\subsection{Linearised model}
The linearised model of the system can be expressed on the standard state space form given in \cref{eq:StateSpace}
\begin{equation}\label{eq:StateSpace}
	\begin{split}
	\dot{x} = Ax + Bu \\
	y = Cx
	\end{split}
\end{equation}
The inputs to our system will be the pump speeds. 
The outputs will be the measured pressure at the tank node and the flows of the pumps. This yields
\begin{equation}\label{eq:StateSpaceInputsOutputs}
	\begin{split}
		u = \begin{bmatrix} \omega_1 \\ \omega_2	\end{bmatrix} \\
		x = \begin{bmatrix} q_c \\ d_f \\ d_{\tau}	\end{bmatrix} \\
		y = \begin{bmatrix} d_1 \\ d_{10} \\ p_{\tau}	\end{bmatrix} \\
	\end{split}
\end{equation}





\subsection{Choice of state variables}

\subsection{Choice of inputs and output variables}

\subsection{Cascaded control}

\subsection{Influence of pump delay}
The pumps of the WDN system introduces a delay of approximately 5 seconds. According to \cite{Skogestad2005} (pp. 182-183), 
a time delay $\theta$ limits the possible bandwidth of a system to be 

\begin{equation}\label{eq:BWdelay}
	\omega_c < \frac{1}{\theta}
\end{equation}

This naturally sets a limitation as to how fast the inner loop of the control structure can be. As the inner loop sets a limitation of how fast the outer loop can be, i.e. 5-10 timer slower than the inner loop.

