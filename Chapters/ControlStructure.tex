This section is concerned with the control structure of the WDN. 
\subsection{Control Structure}\label{Sec:ControlStructure}
This section documents the structure of the control system for this project as seen in \cref{fig:controlstructure}. The intended control structure assumes that the dynamics of the system can be partitioned in two, the fast dynamics of the inertia of the pipes (assuming the pump dynamics are infinitely fast) and the slow dynamics of the tank level.
\begin{figure}[!htb] 
	
	
	\centering
	\begin{tikzpicture}[auto, node distance=2.5cm,>=latex']
		% ========================== Nodes ============================
		% Nodes in upper vertical line
		\node [input, name=rinput] (rinput) {};
		\node [sum, right of=rinput] (sum1) {};
		\node [block, right of=sum1, node distance = 1.5cm] (LQR) {LQR};
		\node [sum, right of=LQR, node distance =
		1.5cm] (sum2) {};
		\node [block, right of=sum2, node distance = 1.5cm] (PI){PI};
		\node [block, right of=PI, align=center] (Fast){Fast\\Dynamics};
		\node [block, right of=Fast, node distance = 3cm, align=center] (Slow){Slow\\Dynamics};
		\node [output, right of=Slow] (output) {};
		
		% Nodes for inner feedback
		\node [tmp, right of=Fast, node distance = 1.5cm] (tmp0){};
		\node [tmp, below of=tmp0, node distance = 1.5cm] (tmp1){};
		\node [tmp, below of=sum2, node distance = 1.5cm] (tmp2){};
		
		% Nodes for outer feedback
		\node [tmp, right of=Slow, node distance = 1.5cm] (tmp10){};
		\node [tmp, below of=tmp10,node distance = 2.5cm] (tmp11){};
		\node [tmp, below of=sum1, node distance = 2.5cm] (tmp12){};
		
		% Nodes for Disturbance
		\node [tmp, above of=tmp0, node distance = 2.5cm] (tmp20){};
		\node [tmp, above of=tmp0, node distance = 2cm] (tmp21){};
		\node [tmp, above of=Fast, node distance = 2cm] (tmp22){};
		\node [tmp, above of=Slow, node distance = 2cm] (tmp23){};
		
		\draw[thick, dotted] ($(Fast.north west)+(-0.25, 0.25)$) rectangle  ($(Slow.south east)+(0.25, -0.25)$);
		\node[above of =tmp0, node distance =1.1cm](sys_txt) {System};
		
		% ========================== Lines ============================
		
		% Lines in upper vertical part of block diagram
		\draw [->] (rinput) -- node{$p_{ref}$} (sum1);
		\draw [->] (sum1) --node[name=z,anchor=north]{} (LQR);
		\draw [->] (LQR) -- node{$ q_{ref} $}(sum2);
		\draw [->] (sum2) -- (PI);
		\draw [->] (PI) -- node[pos=0.4]{$ \omega_{ref} $}(Fast);
		\draw [->] (Fast) -- node{$d_p$}(Slow);
		\draw [->] (Slow) -- node{$p_{\tau}$}(output);	
		
		% Lines for inner feedback
		\draw [-] (tmp0) -- (tmp1);
		\draw [-] (tmp1) -- (tmp2);
		\draw [->] (tmp2) -- node[pos=0.99]{$ - $}(sum2);
		
		
		% Lines for outer feedback
		\draw [-] (tmp10) -- (tmp11);
		\draw [-] (tmp11) -- (tmp12);
		\draw [->] (tmp12) -- node[pos=0.99]{$ - $}(sum1);
		
		
		% Lines for disturbance
		\draw [-] (tmp20)node[above, align=center]{Consumer \\ Disturbance} -- (tmp21);
		\draw [-] (tmp21) -- (tmp22);
		\draw [-] (tmp21) -- (tmp23);
		\draw [->] (tmp22) -- node[left, pos = 0.5]{OD}(Fast);
		\draw [->] (tmp23) -- node[pos = 0.5]{$ d_c $}(Slow);
		
		
	\end{tikzpicture}
	\caption{Control Structure} \label{fig:controlstructure}
\end{figure}


\subsection{System Linearisation}\label{subsec:Linearisation}

Before the model presented in \cref{eq:NonLinearModelWithTank} is truly useful to us - at least within the scope of the \textit{linear} control strategies considered in this project - we must find a way to turn it into a linear model. The typical approach to this problem is \textit{linearisation}, whereby we exploit the extremely powerful Hartman-Grobman theorem, which we present roughly as outlined in \cite{Perko2001}:


\begin{theorem}\label{theorem:HartmanGrobman}
(\textbf{The Hartman-Grobman Theorem}) Let $E$ be an open subset of $\mathbb{R}^n$ containing the origin, and let $f$ be a continuously differentiable function on $E$:
 
\begin{equation*}
f \in C^1(E)
\end{equation*}

Let $\gamma_t$ be the flow of the nonlinear system $\dot{x} = f(x)$. Assume furthermore that there exists an equilibrium point at the origin: 

\begin{equation*}
f(0) = 0
\end{equation*}

and that this equilibrium point is hyberbolic: 

\begin{equation*}
\forall \lambda \in T(A): \ \text{Re}(\lambda) \neq 0, \quad A = \nabla f  
\end{equation*}

where $T$ is the eigenspace of $A$. Then there exists a homeomorphism $H$ of some open set $U, \ 0 \in U$ onto the open set $V, \ 0 \in V$, such that $\forall x_0 \in U$, there is an open interval $I_0 \subset \mathbb{R}, \ 0 \in I_0$ such that:

\begin{equation*}
	\forall x_0 \in U \wedge \forall t \in I_0: \ H \circ \gamma_t(x_0) = e^{At}H(x_0)
\end{equation*}
\end{theorem}

At first glance, this theorem looks opaquely mathematical and not immediately applicable. However, in practice, \cref{theorem:HartmanGrobman} simply tells us that in the immediate vicinity of some hyperbolic equilibrium point of our nonlinear system, there exists a \textit{linear} system that behaves in a generally identical manner when evolved in time. We note that it is not \textit{necessary} to linearise at a hyperbolic equilibrium, but doing so is favourable when possible as it precludes the presence of a center manifold, whose dynamics may not be captured by linearisation.

Recalling that the first-order Taylor series of a function at a point can be thought of as a  generalisation of its tangent line, it is then possible to identify the linearisation of our system via:

\begin{equation}\label{eq:TaylorSeries}
\dot{x} \approx f(x_0) + \nabla f\bigg\rvert_{x_0} (x-x_0)
\end{equation}

We now revert our attention to the nonlinear model of the WDN. We will make the simplifying assumption that $\Phi \mathcal{J} \Phi^T$ is invertible, which is not generally true, but tends to hold for the type of WDN in question. We also introduce the notation $\mathcal{P}: (\Phi \mathcal{J} \Phi^T)^{-1}$, allowing allows us to rewrite \cref{eq:NonLinearModelWithTank} as:

\begin{equation}\label{eq:NonLinearModelSimplified}
	\begin{split}
		\dot{q}_n &=  -\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\
		&= 	-\mathcal{P}\Phi\Big(\lambda(q_n)+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+\alpha(q_n,\omega)\Big) + 	\mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\
		& = -\mathcal{P}\Phi\Big(K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q+a_2|q|q\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big)
	\end{split}	
\end{equation}

We now make the additional observation that $\Psi(\bar{h}-\mathbf{1}h_0)$ is constant for all time,   $\mathcal{I}(p_{\tau}-\mathbf{1}p_0)$ do not depend on $\{q_n,OD,\omega,p_\tau\}$. This suggests that, when computing the Taylor expansion, this term disappears under the action of the $\nabla$ operator, i.e. that:

\begin{equation}\label{eq:PressureHeightDisappear}
	\begin{split}
		\nabla \dot{q}_n &= \nabla \Big(-\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big) + \mathcal{P}\Big(\Psi(\bar{h}-\mathbf{1}h_0) + \mathcal{I}(p_{\tau}-\mathbf{1}p_0)\Big) \\ 
		&=\nabla \Big(-\mathcal{P}\Phi\Big(\lambda(q_n)+\mu(q_n,OD)+\alpha(q_n,\omega)\Big)\Big) + \nabla \mathcal{P}\Big({I}(p_{\tau}-\mathbf{1}p_0)\Big) \\
		&=\nabla \Big(-\mathcal{P}\Phi\Big(K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q+a_2|q|q\Big)\Big) + \nabla \mathcal{P}\Big({I}(p_{\tau}-\mathbf{1}p_0)\Big)
	\end{split}
\end{equation}

Recognizing furthermore that $\Phi$ and $\mathcal{J}$ are simply linear transformations, the linearity of differentiation then allows us to write a general expression for the Taylor expansion of \cref{eq:NonLinearModelSimplified} as:

\begin{equation}\label{eq:SymbolicLinearisation}
	\begin{split}
		\dot{q}_n &\approx f(x_0) + \frac{\partial f}{\partial q_n}\bigg\rvert_{x_0} \tilde{q}_n + \frac{\partial f}{\partial OD}\bigg\rvert_{x_0} \tilde{OD} + \frac{\partial f}{\partial \omega}\bigg\rvert_{x_0} \tilde{\omega} +  \frac{\partial f}{\partial p_\tau}\bigg\rvert_{x_0} \tilde{p}_\tau
		\\
		&= f(x_0) + \mathcal{P}\Big(-\Phi\Big( \frac{\partial \Omega}{\partial q_n}\bigg\rvert_{x_0} \tilde{q}_n + \frac{\partial \Omega}{\partial OD}\bigg\rvert_{x_0} \tilde{OD} + \frac{\partial \Omega}{\partial \omega}\bigg\rvert_{x_0} \tilde{\omega} \Big) + \mathcal{I} \frac{\partial f}{\partial p_\tau}\bigg\rvert_{x_0} \tilde{p}_\tau \Big)
	\end{split}
\end{equation}

where: 

\begin{align}
	x_0 &= \{q_0,OD_0,\omega_0, p_\tau \} \label{eq:EquilibriumPoint} \\
	\Omega &= K_\lambda|q_n|q_n+\frac{|q_n|q_n}{(K_v\cdot OD)^2}+a_0\omega^2+a_1\omega q_n+a_2|q_n|q_n \label{eq:OmegaFun} \\
	\tilde{q}_n &= q_n - q_0 \label{eq:QTilde} \\
	\tilde{OD} &= OD - OD_0 \label{eq:ODTilde} \\ 
	\tilde{\omega} &= \omega - \omega_0 \label{eq:OmegaTilde} \\
	\tilde{p}_\tau &= p_\tau - p_{\tau_0}
\end{align}

Writing out each of the partial derivatives in \cref{eq:SymbolicLinearisation}, we get:

\begin{equation}\label{eq:PartialTaylorQ}
	\frac{\partial \Omega}{\partial q_n}\bigg\rvert_{x_0} 
	=
	a_1\omega_0 + \Big(|q_0|+ \text{sign}(q_0)q_0\Big)\Bigg(K_\lambda + a_2 + \frac{1}{(K_v OD_0)^2}\Bigg) 
\end{equation}

\begin{equation}\label{eq:PartialTaylorOD}
	\frac{\partial \Omega}{\partial OD}\bigg\rvert_{x_0} 
	=
	-|q_0|q_0 \frac{2}{K_v^2 OD_0^3}
\end{equation}

\begin{equation}\label{eq:PartialTaylorOmega}
	\frac{\partial \Omega}{\partial \omega}\bigg\rvert_{x_0} 
	=
	a_1 q_0 + 2a_0\omega_0
\end{equation}

\begin{equation}\label{eq:PartialTaylorPressure}
		\frac{\partial \Omega}{\partial p_\tau}\bigg\rvert_{x_0} 
	=
	1
\end{equation}

and the complete Taylor expansion becomes:

\begin{equation}\label{eq:SymbolicLinearisationExpanded}
	\begin{split}
			\dot{q}_n \approx f(x_0) &-\mathcal{P}\Phi\Bigg(a_1\omega_0 + \Big(|q_0|+\text{sign}(q_0)q_0\Big)\Bigg(K_\lambda + a_2 + \frac{1}{(K_v OD_0)^2}\Bigg) \tilde{q}_n \Bigg)  \\
			&- \mathcal{P}\Phi\Bigg(\Big(-|q_0|q_0 \frac{2}{K_v^2 OD_0^3}\Big) \tilde{OD}\Bigg) \\
			&-  \mathcal{P}\Phi\Bigg(\Big(a_1 q_0 + 2a_0\omega_0\Big) \tilde{\omega}\Bigg) \\
			&+ \mathcal{P} \mathcal{I} \tilde{p}_\tau
	\end{split}
\end{equation}

We will now make three additional abstractions to simplify \cref{eq:SymbolicLinearisationExpanded}. We first exploit the trivial condition that, when linearizing at an equilibrium point, $f(x_0) \equiv 0$. We then consider the fact that, in practice, $OD$ and $p_\tau$ vary very slowly compared to $q_n$ and $\omega$. It is therefore a reasonable assumption that at steady state for the latter variables, the error introduced by neglecting $\frac{\partial\Omega}{\partial OD}$ is:

\begin{equation}\label{eq:IgnoreODError}
	\mathcal{P}\Phi\Big(|\tilde{q}_{ss}|\tilde{q}_{ss}\frac{2}{K_v^2 OD_0^3} \tilde{OD}\Big)
\end{equation}

which, under the assumption that $q_n$ changes much faster than $OD$, is a constant offset and therefore removable by integral action. Analogously, the error induced by ignoring $\frac{\partial\Omega}{\partial p_\tau}$ is: 

\begin{equation}\label{eq:IgnorePressureError}
	\mathcal{P}\mathcal{I}\tilde{p}_\tau
\end{equation}

which is likewise a constant term that may be removed by integral action. Thus, we can restate a greatly simplified form of \cref{eq:SymbolicLinearisationExpanded} as

\begin{equation}\label{eq:SymbolicLinearisationSimplified}
	\dot{q}_n \approx -\mathcal{P}\Phi\Bigg(a_1\omega_0 + \Big(|q_0|+\text{sign}(q_0)q_0\Big)\Bigg(K_\lambda + a_2 + \frac{1}{(K_v OD_0)^2}\Bigg) \tilde{q}_n \Bigg) -  \mathcal{P}\Phi\Bigg(\Big(a_1 q_0 + 2a_0\omega_0\Big) \tilde{\omega}\Bigg)
\end{equation}

\clearpage

\subsection{Linearised model}
In the following section state space models are presented both for the fast and the slow system, that is the pump flow and the tank pressure dynamics respectively. 

\subsubsection{State space model - pump dynamics}
Before linearizing the system model, presented in \cref{eq:NonLinearModelWithTank}, we need to identify the equilibrium points. This is done by evaluating the before mentioned model, at fixed $ \omega $ and $ OD $, with dynamic states set to zero. We choose pump speeds as an average of those used in \cref{ap:PumpCoef}, which is $ 66\% $ for each pump. We set OD to $ 0.5 $ for each valve. This yields the following equilibrium point:

	\begin{equation}
	q_C^* = \kbordermatrix{
		\\
		q_3 & 0.1992 \\ 
		q_7 & 0.0231\\
	}
\end{equation}
	\begin{equation}
	\bar{q}_f^* = \kbordermatrix{
		\\
		d_1 & 0.3752 \\ 
		d_5 & -0.2913\\
		q_9 & -0.2876\\
	}
	\end{equation}

\begin{equation}
	d_t^* = 0
\end{equation}


The linearised model of the system can be expressed on the standard state space form given in \cref{eq:StateSpace} by applying the equilibrium to \cref{eq:SymbolicLinearisationSimplified}
\begin{equation}\label{eq:StateSpace}
	\begin{split}
	\dot{x} = Ax + Bu \\
	y = Cx
	\end{split}
\end{equation}

\begin{equation}
	A = \begin{bmatrix}
		-0.3236 & -0.0406 & -0.1577 & 10.0671 & -0.7623 & 0.0000\\
		-0.1429 & -0.3189 & 0.2176 & -1.3489 & -6.0984  & 0\\
		-0.0275 & 0.0687 & -0.3968 & 7.1758 & 1.5246 & 0\\
		0.1089 & 0.0687 & 0.0196 & -20.2792 & 1.5246 & -0.0000\\
		-0.0551 & -0.0443 & -0.0272 & 1.4425 & -15.3466 &   -0.0999\\
		0.1486 & 0.0817 & -0.2877 & 11.1436 & 8.2419 & -0.4174\\
	\end{bmatrix}
\end{equation}

\begin{equation}
	B = \begin{bmatrix}
		0.0982 & 0.0000\\
		0.0078 & 0 \\
		0.1147 & 0 \\
		-0.0408 & 0 \\
		-0.0087 & -0.0193\\
		-0.0651 & -0.0715
	\end{bmatrix}
\end{equation}

The output matrix $ C $ can be constructed by the fact that the two outputs are; the flow pump at the non reference pump and the flow to/from the tank. 

\begin{equation}
C =	\begin{bmatrix}
	&0&0&1&0&0&0\\
	&0&0&-1&-1&-1&-1\\	
\end{bmatrix} 
\end{equation}

The inputs to our system will be the pump speeds. 
The outputs will be the measured pressure at the tank node and the flows of the pumps. This yields
\begin{equation}\label{eq:StateSpaceInputsOutputsFast}
	\begin{split}
		u = \begin{bmatrix} \omega_1 \\ \omega_2	\end{bmatrix} \\
		x = \begin{bmatrix} q_c \\ d_f \\ d_{\tau}	\end{bmatrix} \\
		y = \begin{bmatrix} d_1 \\ d_{13} \\ 	\end{bmatrix} \\
	\end{split}
\end{equation}

\subsubsection{State space model - tank pressure dynamics}
The tank pressure dynamics is quite a bit more simple than that of the pump flows. For the slow dynamics the pump inputs have got no immediate influence, therefore the input matrix is neglected:
\begin{equation}
	\begin{split}
		\dot{x} = Ax \\
		y = Cx
	\end{split}
\end{equation}

For the case of the tank pressure dynamics the state space model is:
\begin{equation}
		A = \begin{bmatrix}
			0&0&0&0&-0.0001&0
		\end{bmatrix} \\
	\end{equation}
\begin{equation}
		C = \begin{bmatrix}
			-\tau&-\tau&-\tau&-\tau&0&1
		\end{bmatrix}
\end{equation}

\begin{equation}\label{eq:StateSpaceInputsOutputsFast}
	\begin{split}
		x = \begin{bmatrix} d_f \\ d_{\tau} \\ p_{\tau}	\end{bmatrix} \\
		y = \begin{bmatrix} p_\tau \\ \end{bmatrix} \\ 
	\end{split}
\end{equation}

\subsection{Choice of state variables}

\subsection{Choice of inputs and output variables}

\subsection{Cascaded control}

\subsection{Influence of pump delay}
The pumps of the WDN system introduces a delay of approximately 5 seconds. According to \cite{Skogestad2005} (pp. 182-183), 
a time delay $\theta$ limits the possible bandwidth of a system to be 

\begin{equation}\label{eq:BWdelay}
	\omega_c < \frac{1}{\theta}
\end{equation}

This naturally sets a limitation as to how fast the inner loop of the control structure can be. As the inner loop sets a limitation of how fast the outer loop can be, i.e. 5-10 timer slower than the inner loop.

